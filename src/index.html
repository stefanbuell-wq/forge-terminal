<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forge Terminal</title>
  <link rel="stylesheet" href="../node_modules/@xterm/xterm/css/xterm.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

    /* ── CSS Variables ─────────────────────────────────────────── */
    :root {
      --bg-deep: #070b10;
      --bg-primary: #0a0e14;
      --bg-secondary: #0f1923;
      --bg-tertiary: #151f2c;
      --bg-hover: #1a2736;
      --border: #1c2b3a;
      --border-active: #2d4a5e;
      --text-primary: #d4dce8;
      --text-secondary: #7a8da0;
      --text-muted: #4a5b6e;
      --accent: #22d3ee;
      --accent-glow: rgba(34, 211, 238, 0.15);
      --accent-dim: rgba(34, 211, 238, 0.6);
      --green: #4ade80;
      --green-glow: rgba(74, 222, 128, 0.15);
      --orange: #fb923c;
      --red: #f87171;
      --gold: #fbbf24;
      --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'SF Mono', monospace;
      --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --sidebar-width: 260px;
      --titlebar-height: 42px;
      --tab-height: 40px;
      --statusbar-height: 28px;
    }

    /* ── Reset ─────────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-ui);
      background: var(--bg-deep);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
      user-select: none;
    }

    /* ── Title Bar ────────────────────────────────────────────── */
    .titlebar {
      height: var(--titlebar-height);
      background: var(--bg-deep);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      -webkit-app-region: drag;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .titlebar-brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
    }

    .titlebar-brand svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .titlebar-controls {
      display: flex;
      gap: 2px;
      -webkit-app-region: no-drag;
    }

    .titlebar-btn {
      width: 36px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .titlebar-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .titlebar-btn.close:hover { background: var(--red); color: white; }
    .titlebar-btn svg { width: 14px; height: 14px; }

    /* ── Layout ────────────────────────────────────────────────── */
    .app-layout {
      display: flex;
      height: calc(100vh - var(--titlebar-height));
    }

    /* ── Sidebar ──────────────────────────────────────────────── */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-primary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-section {
      padding: 16px 14px;
      flex-shrink: 0;
    }

    .sidebar-section:not(:last-child) {
      border-bottom: 1px solid var(--border);
    }

    .sidebar-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* ── AI Provider Toggle ───────────────────────────────────── */
    .provider-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .provider-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    .provider-item:hover { background: var(--bg-hover); }
    .provider-item.active {
      background: var(--accent-glow);
      border-color: var(--border-active);
    }

    .provider-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .provider-dot.claude { background: var(--accent); box-shadow: 0 0 8px var(--accent-dim); }
    .provider-dot.openai { background: var(--green); box-shadow: 0 0 8px rgba(74,222,128,0.4); }
    .provider-dot.ollama { background: var(--orange); box-shadow: 0 0 8px rgba(251,146,60,0.4); }
    .provider-dot.custom { background: var(--gold); box-shadow: 0 0 8px rgba(251,191,36,0.4); }

    .provider-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .provider-status {
      font-size: 10px;
      color: var(--text-muted);
      margin-left: auto;
    }

    /* ── Auto-Accept Toggle ───────────────────────────────────── */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 8px;
    }

    .toggle-label {
      font-size: 13px;
      color: var(--text-primary);
    }

    .toggle-sublabel {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .toggle-switch {
      width: 38px;
      height: 20px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: all 0.25s;
      flex-shrink: 0;
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--text-secondary);
      top: 2px;
      left: 2px;
      transition: all 0.25s;
    }
    .toggle-switch.active {
      background: var(--accent);
      border-color: var(--accent);
    }
    .toggle-switch.active::after {
      background: white;
      left: 20px;
    }

    /* ── Danger Level Selector ────────────────────────────────── */
    .accept-levels {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
    }

    .accept-level {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      transition: all 0.15s;
    }
    .accept-level:hover { background: var(--bg-hover); color: var(--text-primary); }
    .accept-level.active { color: var(--text-primary); }

    .level-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .level-indicator.safe { background: var(--green); }
    .level-indicator.moderate { background: var(--orange); }
    .level-indicator.yolo { background: var(--red); }

    /* ── Quick Actions ────────────────────────────────────────── */
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .quick-action {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-family: var(--font-ui);
      transition: all 0.15s;
      text-align: left;
    }
    .quick-action:hover { background: var(--bg-hover); color: var(--text-primary); }
    .quick-action svg { width: 16px; height: 16px; flex-shrink: 0; }

    .sidebar-spacer { flex: 1; flex-shrink: 0; }

    .sidebar-footer {
      padding: 14px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      flex-shrink: 0;
    }

    /* ── Main Content ─────────────────────────────────────────── */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* ── Tab Bar ──────────────────────────────────────────────── */
    .tab-bar {
      height: var(--tab-height);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 2px;
      overflow-x: auto;
    }

    .tab {
      height: 30px;
      padding: 0 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      border: 1px solid transparent;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .tab:hover { background: var(--bg-hover); color: var(--text-primary); }
    .tab.active {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border);
    }

    .tab-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
    }

    .tab-close {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      opacity: 0;
      transition: all 0.15s;
    }
    .tab:hover .tab-close { opacity: 0.5; }
    .tab-close:hover { opacity: 1 !important; background: var(--bg-tertiary); }

    .tab-new {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      border: none;
      background: none;
      transition: all 0.15s;
    }
    .tab-new:hover { background: var(--bg-hover); color: var(--text-primary); }
    .tab-new svg { width: 14px; height: 14px; }

    /* ── Terminal Area ─────────────────────────────────────────── */
    .terminal-container {
      flex: 1;
      background: var(--bg-primary);
      position: relative;
      overflow: hidden;
    }

    .terminal-instance {
      position: absolute;
      inset: 0;
      padding: 8px 12px;
      display: none;
    }
    .terminal-instance.active { display: block; }

    /* xterm overrides for our theme */
    .xterm { height: 100%; }
    .xterm-viewport { overflow-y: auto !important; }
    .xterm-viewport::-webkit-scrollbar { width: 8px; }
    .xterm-viewport::-webkit-scrollbar-track { background: transparent; }
    .xterm-viewport::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    .xterm-viewport::-webkit-scrollbar-thumb:hover {
      background: var(--border-active);
    }

    /* ── Status Bar ───────────────────────────────────────────── */
    .statusbar {
      height: var(--statusbar-height);
      background: var(--bg-deep);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    .statusbar-left, .statusbar-right {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
    }

    .statusbar-right {
      overflow: hidden;
    }

    .statusbar-right .status-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #statusCwd {
      max-width: 250px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .status-dot.online { background: var(--green); box-shadow: 0 0 6px rgba(74,222,128,0.5); }
    .status-dot.warning { background: var(--orange); }
    .status-dot.offline { background: var(--red); }

    /* ── Overlay / Welcome ────────────────────────────────────── */
    .welcome-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      z-index: 10;
      gap: 20px;
      transition: opacity 0.3s;
    }
    .welcome-overlay.hidden { opacity: 0; pointer-events: none; }

    .welcome-logo {
      width: 64px;
      height: 64px;
      color: var(--accent);
      opacity: 0.4;
    }

    .welcome-text {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      line-height: 1.6;
    }

    .welcome-kbd {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* ── Auto-Accept Banner ───────────────────────────────────── */
    .auto-accept-banner {
      background: linear-gradient(90deg, rgba(251,146,60,0.08), rgba(248,113,113,0.08));
      border-bottom: 1px solid rgba(251,146,60,0.2);
      padding: 6px 14px;
      font-size: 11px;
      color: var(--orange);
      display: none;
      align-items: center;
      gap: 8px;
    }
    .auto-accept-banner.visible { display: flex; }
    .auto-accept-banner svg { width: 14px; height: 14px; flex-shrink: 0; }

    /* ── Autocomplete Ghost Text ─────────────────────────────────── */
    .autocomplete-ghost {
      position: absolute;
      pointer-events: none;
      z-index: 10;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      color: rgba(34, 211, 238, 0.7);
      white-space: pre;
      text-shadow: 0 0 8px rgba(34, 211, 238, 0.3);
      opacity: 1 !important;
    }

    .autocomplete-hint {
      position: fixed;
      bottom: 36px;
      right: 14px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--accent);
      background: var(--bg-secondary);
      border: 1px solid var(--border-active);
      border-radius: 6px;
      padding: 4px 12px;
      opacity: 0;
      transition: opacity 0.25s;
      z-index: 20;
      box-shadow: 0 2px 12px rgba(34, 211, 238, 0.1);
    }
    .autocomplete-hint.visible { opacity: 1; }

    /* ── Autocomplete Status Indicator ────────────────────────────── */
    .ac-status-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .ac-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s;
    }
    .ac-status-dot.active { background: var(--accent); box-shadow: 0 0 6px var(--accent-dim); }
    .ac-status-dot.requesting {
      background: var(--gold);
      box-shadow: 0 0 6px rgba(251, 191, 36, 0.5);
      animation: ac-pulse 0.8s infinite;
    }

    @keyframes ac-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ── AI Status Indicator ──────────────────────────────────────── */
    .ai-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ── Autocomplete Provider Selector ────────────────────────────── */
    .ac-provider-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .ac-provider-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 10px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .ac-provider-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .ac-provider-item.active {
      background: var(--accent-glow);
      border-color: var(--border-active);
      color: var(--text-primary);
    }

    .ac-provider-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .ac-provider-dot.ollama { background: var(--orange); box-shadow: 0 0 6px rgba(251,146,60,0.4); }
    .ac-provider-dot.huggingface { background: #fbbf24; box-shadow: 0 0 6px rgba(251,191,36,0.4); }

    .ac-provider-status {
      margin-left: auto;
      font-size: 10px;
      color: var(--text-muted);
    }

    .hf-key-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .hf-key-input {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 8px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
    }
    .hf-key-input:focus { border-color: var(--border-active); }
    .hf-key-input::placeholder { color: var(--text-muted); }

    .hf-key-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .hf-key-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-active); }

    /* ── Screenshot Picker Overlay ────────────────────────────────── */
    .screenshot-overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 11, 16, 0.92);
      z-index: 100;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      overflow-y: auto;
    }
    .screenshot-overlay.visible { display: flex; }

    .screenshot-overlay-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .screenshot-overlay-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .screenshot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      width: 100%;
      max-width: 960px;
    }

    .screenshot-source {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .screenshot-source:hover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
      box-shadow: 0 0 16px var(--accent-glow);
    }

    .screenshot-source img {
      width: 100%;
      border-radius: 6px;
      background: #000;
    }

    .screenshot-source-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ── Animations ────────────────────────────────────────────── */
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 6px var(--accent-dim); }
      50% { box-shadow: 0 0 14px var(--accent); }
    }

    .glow-pulse { animation: pulse-glow 2s infinite; }

    /* ── Font Size Controls ────────────────────────────────────── */
    .font-size-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
    }

    .font-size-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 14px;
      font-family: var(--font-mono);
      cursor: pointer;
      transition: all 0.15s;
    }
    .font-size-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-active);
    }

    .font-size-display {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      min-width: 36px;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- ── Title Bar ──────────────────────────────────────────────── -->
<div class="titlebar">
  <div class="titlebar-brand">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
    </svg>
    FORGE TERMINAL
  </div>
  <div class="titlebar-controls">
    <button class="titlebar-btn" onclick="forgeAPI.minimize()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
    <button class="titlebar-btn" onclick="forgeAPI.maximize()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="5" width="14" height="14" rx="1"/></svg>
    </button>
    <button class="titlebar-btn close" onclick="forgeAPI.close()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="6" y1="6" x2="18" y2="18"/><line x1="18" y1="6" x2="6" y2="18"/></svg>
    </button>
  </div>
</div>

<!-- ── App Layout ─────────────────────────────────────────────── -->
<div class="app-layout">

  <!-- ── Sidebar ────────────────────────────────────────────── -->
  <div class="sidebar">
    
    <div class="sidebar-section">
      <div class="sidebar-label">AI Provider</div>
      <div class="provider-list" id="providerList">
        <div class="provider-item active" data-provider="claude">
          <span class="provider-dot claude"></span>
          <span class="provider-name">Claude Code</span>
          <span class="provider-status">v2.x</span>
        </div>
        <div class="provider-item" data-provider="openai">
          <span class="provider-dot openai"></span>
          <span class="provider-name">OpenAI Codex</span>
          <span class="provider-status">soon</span>
        </div>
        <div class="provider-item" data-provider="ollama">
          <span class="provider-dot ollama"></span>
          <span class="provider-name">Ollama Local</span>
          <span class="provider-status">soon</span>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Auto-Accept</div>
      <div class="toggle-row">
        <div>
          <div class="toggle-label">Aktiviert</div>
          <div class="toggle-sublabel">Bestätigungen überspringen</div>
        </div>
        <div class="toggle-switch" id="autoAcceptToggle"></div>
      </div>
      <div class="accept-levels" id="acceptLevels">
        <div class="accept-level active" data-level="safe">
          <span class="level-indicator safe"></span>
          Sicher — Nur Read-Ops
        </div>
        <div class="accept-level" data-level="moderate">
          <span class="level-indicator moderate"></span>
          Moderat — Read + Write
        </div>
        <div class="accept-level" data-level="yolo">
          <span class="level-indicator yolo"></span>
          YOLO — Alles akzeptieren
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Quick Actions</div>
      <div class="quick-actions">
        <button class="quick-action" id="btnLaunchClaude">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
          </svg>
          Claude Code starten
        </button>
        <button class="quick-action" id="btnNewTab">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          Neuer Tab
        </button>
        <button class="quick-action" id="btnClearTerminal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          Terminal leeren
        </button>
        <button class="quick-action" id="btnScreenshot">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Screenshot
        </button>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Einstellungen</div>
      <div class="font-size-controls">
        <button class="font-size-btn" id="btnFontMinus" title="Schrift verkleinern">−</button>
        <span class="font-size-display" id="fontSizeDisplay">14px</span>
        <button class="font-size-btn" id="btnFontPlus" title="Schrift vergrößern">+</button>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">KI Autocomplete</div>
      <div class="ac-provider-list" id="acProviderList">
        <div class="ac-provider-item" data-ac-provider="ollama">
          <span class="ac-provider-dot ollama"></span>
          <span>Ollama (Lokal)</span>
          <span class="ac-provider-status" id="ollamaAcStatus">Offline</span>
        </div>
        <div class="ac-provider-item active" data-ac-provider="huggingface">
          <span class="ac-provider-dot huggingface"></span>
          <span>Hugging Face</span>
          <span class="ac-provider-status" id="hfAcStatus">Kein Key</span>
        </div>
      </div>
      <div class="hf-key-row" id="hfKeyRow">
        <input type="password" class="hf-key-input" id="hfKeyInput" placeholder="hf_... API Token" />
        <button class="hf-key-btn" id="hfKeyBtn">OK</button>
      </div>
      <div class="toggle-row">
        <div>
          <div class="toggle-label">Autocomplete</div>
          <div class="toggle-sublabel">KI-Vorschläge im Terminal</div>
        </div>
        <div class="toggle-switch" id="autocompleteToggle"></div>
      </div>
    </div>

    <div class="sidebar-spacer"></div>

    <div class="sidebar-footer">
      Forge Terminal v2.0.0 — Built with ⚡
    </div>
  </div>

  <!-- ── Main Content ───────────────────────────────────────── -->
  <div class="main-content">
    
    <!-- Tab Bar -->
    <div class="tab-bar" id="tabBar">
      <button class="tab-new" id="btnTabNew" title="Neuer Tab">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
    </div>

    <!-- Auto-Accept Banner -->
    <div class="auto-accept-banner" id="autoAcceptBanner">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <span>Auto-Accept aktiv — Claude Code überspringt Bestätigungen</span>
    </div>

    <!-- Terminal Container -->
    <div class="terminal-container" id="terminalContainer">
      <div class="welcome-overlay" id="welcomeOverlay">
        <svg class="welcome-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
        </svg>
        <div class="welcome-text">
          Willkommen bei <strong>Forge Terminal</strong><br>
          Drücke <span class="welcome-kbd">Ctrl+T</span> für einen neuen Tab<br>
          oder klicke <strong>Claude Code starten</strong> in der Sidebar
        </div>
      </div>
    </div>

    <!-- Autocomplete Hint -->
    <div class="autocomplete-hint" id="autocompleteHint">Tab = annehmen · Esc = verwerfen</div>

    <!-- Status Bar -->
    <div class="statusbar">
      <div class="statusbar-left">
        <div class="status-item">
          <span class="status-dot online" id="statusDot"></span>
          <span id="statusText">Bereit</span>
        </div>
        <div class="status-item" id="statusShell">bash</div>
      </div>
      <div class="statusbar-right">
        <div class="status-item" id="statusCwd"></div>
        <div class="status-item" id="statusFontSize">14px</div>
        <div class="status-item" id="statusProvider">Claude Code</div>
        <div class="status-item ac-status-indicator" id="statusAutocomplete">
          <span class="ac-status-dot" id="acStatusDot"></span>
          <span id="acStatusText">AC: Aus</span>
        </div>
        <div class="status-item" id="statusAutoAccept">Auto-Accept: Aus</div>
      </div>
    </div>

  </div>
</div>

<!-- Screenshot Picker Overlay -->
<div class="screenshot-overlay" id="screenshotOverlay">
  <div class="screenshot-overlay-title">Screenshot-Ziel waehlen</div>
  <div class="screenshot-overlay-hint">Klicke auf ein Fenster oder einen Bildschirm — Esc zum Abbrechen</div>
  <div class="screenshot-grid" id="screenshotGrid"></div>
</div>

<!-- ── Scripts ─────────────────────────────────────────────────── -->
<script src="../node_modules/@xterm/xterm/lib/xterm.js"></script>
<script src="../node_modules/@xterm/addon-fit/lib/addon-fit.js"></script>
<script src="../node_modules/@xterm/addon-web-links/lib/addon-web-links.js"></script>

<script>
  // ── State ────────────────────────────────────────────────────
  const state = {
    tabs: [],
    activeTabId: null,
    autoAccept: false,
    acceptLevel: 'safe',
    provider: 'claude',
    tabCounter: 0,
    fontSize: parseInt(localStorage.getItem('forge-fontSize')) || 14,
    ollamaAvailable: false,
    hfAvailable: false,
    autocompleteProvider: localStorage.getItem('forge-ac-provider') || 'huggingface',
    autocompleteEnabled: JSON.parse(localStorage.getItem('forge-autocomplete') || 'false'),
    autocomplete: {
      pending: false,
      suggestion: null,
      inputBuffer: '',
      debounceTimer: null,
    },
  };

  // ── DOM References ───────────────────────────────────────────
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const tabBar = $('#tabBar');
  const terminalContainer = $('#terminalContainer');
  const welcomeOverlay = $('#welcomeOverlay');

  // ── Terminal Theme ───────────────────────────────────────────
  const termTheme = {
    background: '#0a0e14',
    foreground: '#d4dce8',
    cursor: '#22d3ee',
    cursorAccent: '#0a0e14',
    selectionBackground: 'rgba(34, 211, 238, 0.2)',
    selectionForeground: '#d4dce8',
    black: '#0a0e14',
    red: '#f87171',
    green: '#4ade80',
    yellow: '#fbbf24',
    blue: '#60a5fa',
    magenta: '#c084fc',
    cyan: '#22d3ee',
    white: '#d4dce8',
    brightBlack: '#4a5b6e',
    brightRed: '#fca5a5',
    brightGreen: '#86efac',
    brightYellow: '#fde68a',
    brightBlue: '#93c5fd',
    brightMagenta: '#d8b4fe',
    brightCyan: '#67e8f9',
    brightWhite: '#f1f5f9',
  };

  // ── Create Tab ───────────────────────────────────────────────
  async function createTab(launchClaude = false, cwd = null) {
    const tabId = ++state.tabCounter;

    // Create terminal instance
    const term = new Terminal({
      theme: termTheme,
      fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
      fontSize: state.fontSize,
      lineHeight: 1.4,
      cursorBlink: true,
      cursorStyle: 'bar',
      scrollback: 10000,
      allowProposedApi: true,
    });

    // Allow Ctrl+Plus/Minus to pass through to our handler
    term.attachCustomKeyEventHandler((e) => {
      if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '=')) {
        return false; // Let the DOM handle it
      }
      return true;
    });

    const fitAddon = new FitAddon.FitAddon();
    const webLinksAddon = new WebLinksAddon.WebLinksAddon();
    term.loadAddon(fitAddon);
    term.loadAddon(webLinksAddon);

    // Create terminal DOM element
    const termEl = document.createElement('div');
    termEl.className = 'terminal-instance';
    termEl.id = `term-${tabId}`;
    terminalContainer.appendChild(termEl);

    term.open(termEl);
    fitAddon.fit();

    // Create PTY
    const ptyOptions = {
      cols: term.cols,
      rows: term.rows,
      autoAccept: state.autoAccept && state.acceptLevel === 'yolo',
    };
    if (cwd) ptyOptions.cwd = cwd;
    const result = await forgeAPI.createTerminal(ptyOptions);

    // Wire up data with autocomplete interception
    term.onData((data) => {
      const tab = state.tabs.find(t => t.ptyId === result.id);
      if (tab && state.autocompleteEnabled) {
        const action = handleTerminalInput(tab, data);
        if (action === 'consumed') return; // Tab accepted autocomplete
      }
      forgeAPI.sendInput(result.id, data);
    });

    // Build tab name
    let tabName;
    if (launchClaude && cwd) {
      const folderName = cwd.split(/[/\\]/).pop() || cwd;
      tabName = `⚡ Claude — ${folderName}`;
    } else if (launchClaude) {
      tabName = `⚡ Claude ${tabId}`;
    } else {
      tabName = `Terminal ${tabId}`;
    }

    // Store tab info
    const tab = {
      id: tabId,
      ptyId: result.id,
      term,
      fitAddon,
      name: tabName,
      cwd: cwd || result.cwd,
      shell: result.shell,
    };
    state.tabs.push(tab);

    // Create tab UI
    renderTabs();
    switchToTab(tabId);

    // Hide welcome
    welcomeOverlay.classList.add('hidden');

    // Resize observer
    const resizeObserver = new ResizeObserver(() => {
      fitAddon.fit();
      forgeAPI.resizeTerminal(result.id, term.cols, term.rows);
    });
    resizeObserver.observe(termEl);

    // Launch Claude if requested
    if (launchClaude) {
      setTimeout(() => {
        forgeAPI.launchClaude(result.id, []);
      }, 500);
    }

    return tab;
  }

  // ── Render Tabs ──────────────────────────────────────────────
  function renderTabs() {
    // Remove old tabs
    tabBar.querySelectorAll('.tab').forEach(el => el.remove());
    const newBtn = $('#btnTabNew');

    state.tabs.forEach((tab) => {
      const tabEl = document.createElement('div');
      tabEl.className = `tab ${tab.id === state.activeTabId ? 'active' : ''}`;
      tabEl.innerHTML = `
        <span class="tab-dot"></span>
        <span>${tab.name}</span>
        <span class="tab-close" data-tab="${tab.id}">✕</span>
      `;
      tabEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-close')) {
          closeTab(tab.id);
        } else {
          switchToTab(tab.id);
        }
      });
      tabBar.insertBefore(tabEl, newBtn);
    });
  }

  // ── Switch Tab ───────────────────────────────────────────────
  function switchToTab(tabId) {
    state.activeTabId = tabId;

    // Hide all terminals
    $$('.terminal-instance').forEach(el => el.classList.remove('active'));

    // Show active
    const termEl = $(`#term-${tabId}`);
    if (termEl) termEl.classList.add('active');

    // Focus and fit
    const tab = state.tabs.find(t => t.id === tabId);
    if (tab) {
      setTimeout(() => {
        tab.fitAddon.fit();
        tab.term.focus();
      }, 50);

      // Update statusbar CWD (show last 2 path segments)
      if (tab.cwd) {
        const sep = tab.cwd.includes('\\') ? '\\' : '/';
        const parts = tab.cwd.split(/[/\\]/).filter(Boolean);
        const short = parts.length > 2 ? '...' + sep + parts.slice(-2).join(sep) : tab.cwd;
        $('#statusCwd').textContent = short;
      } else {
        $('#statusCwd').textContent = '';
      }
      $('#statusShell').textContent = tab.shell || 'bash';
    }

    renderTabs();
  }

  // ── Close Tab ────────────────────────────────────────────────
  function closeTab(tabId) {
    const idx = state.tabs.findIndex(t => t.id === tabId);
    if (idx === -1) return;

    const tab = state.tabs[idx];
    forgeAPI.killTerminal(tab.ptyId);
    tab.term.dispose();
    $(`#term-${tabId}`)?.remove();
    state.tabs.splice(idx, 1);

    if (state.tabs.length === 0) {
      state.activeTabId = null;
      welcomeOverlay.classList.remove('hidden');
    } else if (state.activeTabId === tabId) {
      switchToTab(state.tabs[Math.max(0, idx - 1)].id);
    }

    renderTabs();
  }

  // ── Handle PTY data ──────────────────────────────────────────
  forgeAPI.onTerminalData(({ id, data }) => {
    const tab = state.tabs.find(t => t.ptyId === id);
    if (tab) tab.term.write(data);
  });

  forgeAPI.onTerminalExit(({ id }) => {
    const tab = state.tabs.find(t => t.ptyId === id);
    if (tab) {
      tab.term.write('\r\n\x1b[90m[Process exited]\x1b[0m\r\n');
    }
  });

  // ── Sidebar: Provider Selection ──────────────────────────────
  $$('.provider-item').forEach(item => {
    item.addEventListener('click', () => {
      $$('.provider-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      state.provider = item.dataset.provider;
      $('#statusProvider').textContent = item.querySelector('.provider-name').textContent;
    });
  });

  // ── Sidebar: Auto-Accept Toggle ──────────────────────────────
  const autoAcceptToggle = $('#autoAcceptToggle');
  autoAcceptToggle.addEventListener('click', () => {
    state.autoAccept = !state.autoAccept;
    autoAcceptToggle.classList.toggle('active', state.autoAccept);
    $('#autoAcceptBanner').classList.toggle('visible', state.autoAccept);
    $('#statusAutoAccept').textContent = state.autoAccept 
      ? `Auto-Accept: ${state.acceptLevel.toUpperCase()}` 
      : 'Auto-Accept: Aus';
  });

  // ── Sidebar: Accept Levels ───────────────────────────────────
  $$('.accept-level').forEach(level => {
    level.addEventListener('click', () => {
      $$('.accept-level').forEach(l => l.classList.remove('active'));
      level.classList.add('active');
      state.acceptLevel = level.dataset.level;
      if (state.autoAccept) {
        $('#statusAutoAccept').textContent = `Auto-Accept: ${state.acceptLevel.toUpperCase()}`;
      }
    });
  });

  // ── Font Size Controls ───────────────────────────────────────
  function changeFontSize(delta) {
    state.fontSize = Math.max(8, Math.min(28, state.fontSize + delta));
    localStorage.setItem('forge-fontSize', state.fontSize);
    $('#fontSizeDisplay').textContent = `${state.fontSize}px`;
    $('#statusFontSize').textContent = `${state.fontSize}px`;
    // Update all open terminals
    state.tabs.forEach((tab) => {
      tab.term.options.fontSize = state.fontSize;
      tab.fitAddon.fit();
      forgeAPI.resizeTerminal(tab.ptyId, tab.term.cols, tab.term.rows);
    });
  }

  // Initialize font size display
  $('#fontSizeDisplay').textContent = `${state.fontSize}px`;
  $('#statusFontSize').textContent = `${state.fontSize}px`;

  $('#btnFontMinus').addEventListener('click', () => changeFontSize(-1));
  $('#btnFontPlus').addEventListener('click', () => changeFontSize(1));

  // ── Quick Actions ────────────────────────────────────────────
  $('#btnLaunchClaude').addEventListener('click', async () => {
    const cwd = await forgeAPI.openFolderDialog();
    if (!cwd) return; // User cancelled
    createTab(true, cwd);
  });
  $('#btnNewTab').addEventListener('click', () => createTab(false));
  $('#btnTabNew').addEventListener('click', () => createTab(false));
  $('#btnClearTerminal').addEventListener('click', () => {
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab) {
      tab.term.clear();
      forgeAPI.sendInput(tab.ptyId, 'clear\r');
    }
  });

  // ── Screenshot ────────────────────────────────────────────────
  const screenshotOverlay = $('#screenshotOverlay');
  const screenshotGrid = $('#screenshotGrid');

  function closeScreenshotPicker() {
    screenshotOverlay.classList.remove('visible');
    screenshotGrid.innerHTML = '';
  }

  async function openScreenshotPicker() {
    const statusText = $('#statusText');
    statusText.textContent = 'Lade Fenster...';

    const sources = await forgeAPI.getScreenshotSources();
    screenshotGrid.innerHTML = '';

    for (const source of sources) {
      const card = document.createElement('div');
      card.className = 'screenshot-source';
      card.innerHTML = `
        <img src="${source.thumbnail}" alt="${source.name}" />
        <div class="screenshot-source-name">${source.name}</div>
      `;
      card.addEventListener('click', async () => {
        closeScreenshotPicker();
        statusText.textContent = 'Screenshot...';
        try {
          const filePath = await forgeAPI.takeScreenshot(source.id);
          if (filePath) {
            statusText.textContent = `Screenshot: ${filePath.split(/[/\\]/).pop()}`;
            setTimeout(() => { statusText.textContent = 'Bereit'; }, 4000);
          }
        } catch {
          statusText.textContent = 'Screenshot fehlgeschlagen';
          setTimeout(() => { statusText.textContent = 'Bereit'; }, 3000);
        }
      });
      screenshotGrid.appendChild(card);
    }

    screenshotOverlay.classList.add('visible');
    statusText.textContent = 'Bereit';
  }

  screenshotOverlay.addEventListener('click', (e) => {
    if (e.target === screenshotOverlay) closeScreenshotPicker();
  });

  $('#btnScreenshot').addEventListener('click', openScreenshotPicker);

  // ── Autocomplete Engine ──────────────────────────────────────
  const acHint = $('#autocompleteHint');
  const acStatusDot = $('#acStatusDot');
  const acStatusText = $('#acStatusText');

  function updateAcStatus(mode) {
    // mode: 'off' | 'idle' | 'no-provider' | 'requesting' | 'active'
    acStatusDot.className = 'ac-status-dot';
    switch (mode) {
      case 'off':
        acStatusText.textContent = 'AC: Aus';
        break;
      case 'no-provider':
        acStatusText.textContent = 'AC: Kein Provider';
        break;
      case 'idle':
        acStatusText.textContent = 'AC: Bereit';
        acStatusDot.classList.add('active');
        break;
      case 'requesting':
        acStatusText.textContent = 'AC: ...';
        acStatusDot.classList.add('requesting');
        break;
      case 'active':
        acStatusText.textContent = 'AC: Vorschlag';
        acStatusDot.classList.add('active');
        break;
    }
  }

  function refreshAcStatus() {
    if (!state.autocompleteEnabled) { updateAcStatus('off'); return; }
    const providerReady = state.autocompleteProvider === 'ollama' ? state.ollamaAvailable : state.hfAvailable;
    updateAcStatus(providerReady ? 'idle' : 'no-provider');
  }

  // Set initial status
  refreshAcStatus();

  function clearAutocomplete() {
    state.autocomplete.suggestion = null;
    acHint.classList.remove('visible');
    // Remove ghost overlays
    document.querySelectorAll('.autocomplete-ghost').forEach(el => el.remove());
    // Reset statusbar
    refreshAcStatus();
  }

  function showGhostText(tab, text) {
    // Remove old ghost
    document.querySelectorAll('.autocomplete-ghost').forEach(el => el.remove());
    if (!text) return;

    const termEl = document.querySelector(`#term-${tab.id}`);
    if (!termEl) return;

    // Get cursor position from xterm
    const cursorRow = tab.term.buffer.active.cursorY;
    const cursorCol = tab.term.buffer.active.cursorX;

    // Calculate pixel position
    const cellWidth = tab.term._core._renderService.dimensions.css.cell.width;
    const cellHeight = tab.term._core._renderService.dimensions.css.cell.height;

    // Find xterm screen element for precise positioning
    const xtermScreen = termEl.querySelector('.xterm-screen');
    const targetParent = xtermScreen || termEl;

    const ghost = document.createElement('div');
    ghost.className = 'autocomplete-ghost';
    ghost.style.left = `${cursorCol * cellWidth}px`;
    ghost.style.top = `${cursorRow * cellHeight}px`;
    ghost.style.fontSize = `${state.fontSize}px`;
    ghost.style.lineHeight = `${cellHeight}px`;
    ghost.textContent = text;
    targetParent.appendChild(ghost);

    acHint.classList.add('visible');
    state.autocomplete.suggestion = text;
    updateAcStatus('active');
  }

  async function requestAutocomplete(tab) {
    if (!state.autocompleteEnabled) return;
    const providerReady = state.autocompleteProvider === 'ollama'
      ? state.ollamaAvailable
      : state.hfAvailable;
    if (!providerReady) {
      updateAcStatus('no-provider');
      return;
    }
    if (state.autocomplete.pending) return;

    const buffer = state.autocomplete.inputBuffer.trim();
    if (buffer.length < 2) {
      clearAutocomplete();
      return;
    }

    state.autocomplete.pending = true;
    updateAcStatus('requesting');

    const prompt = `Complete this shell command. Only output the remaining characters to complete it, nothing else. No explanation, no repeating what's already typed.\n$ ${buffer}`;
    const completeOptions = {
      maxTokens: 40,
      temperature: 0.1,
      stop: ['\n', '\r', '```', '$'],
      timeout: state.autocompleteProvider === 'huggingface' ? 4000 : 2000,
    };

    try {
      const result = state.autocompleteProvider === 'huggingface'
        ? await forgeAPI.hfComplete(prompt, completeOptions)
        : await forgeAPI.ollamaComplete(prompt, completeOptions);

      const currentBuffer = state.autocomplete.inputBuffer.trim();
      if (result && currentBuffer.startsWith(buffer)) {
        let cleaned = result.replace(/^\s+/, '');

        // If the model repeated the input, strip it
        if (cleaned.toLowerCase().startsWith(buffer.toLowerCase())) {
          cleaned = cleaned.slice(buffer.length);
        }
        // Also strip any extra chars the user typed since the request
        const extraTyped = currentBuffer.slice(buffer.length);
        if (extraTyped && cleaned.startsWith(extraTyped)) {
          cleaned = cleaned.slice(extraTyped.length);
        }

        cleaned = cleaned.replace(/^\s+/, '');
        if (cleaned.length > 0) {
          showGhostText(tab, cleaned);
        }
      }
    } catch (err) { console.error('[AC] request error:', err); }

    state.autocomplete.pending = false;
    // If no suggestion was shown, go back to idle
    if (!state.autocomplete.suggestion && state.autocompleteEnabled) {
      updateAcStatus('idle');
    }
  }

  function handleTerminalInput(tab, data) {
    // Track input buffer between prompts
    if (data === '\r' || data === '\n') {
      // Enter — clear buffer
      clearAutocomplete();
      state.autocomplete.inputBuffer = '';
      return;
    }

    if (data === '\x7f' || data === '\b') {
      // Backspace
      state.autocomplete.inputBuffer = state.autocomplete.inputBuffer.slice(0, -1);
    } else if (data === '\x1b' || data.startsWith('\x1b[')) {
      // Escape or arrow keys — dismiss autocomplete
      clearAutocomplete();
      return;
    } else if (data === '\t') {
      // Tab — accept autocomplete
      if (state.autocomplete.suggestion) {
        forgeAPI.sendInput(tab.ptyId, state.autocomplete.suggestion);
        state.autocomplete.inputBuffer += state.autocomplete.suggestion;
        clearAutocomplete();
        return 'consumed'; // don't send tab to PTY
      }
    } else if (data.length === 1 && data.charCodeAt(0) >= 32) {
      // Printable character
      state.autocomplete.inputBuffer += data;
    } else {
      // Control chars — clear
      clearAutocomplete();
      return;
    }

    // Debounced autocomplete request
    clearTimeout(state.autocomplete.debounceTimer);
    clearAutocomplete();
    state.autocomplete.debounceTimer = setTimeout(() => {
      requestAutocomplete(tab);
    }, 400);
  }

  // ── Autocomplete Sidebar Controls ──────────────────────────
  const autocompleteToggle = $('#autocompleteToggle');
  if (state.autocompleteEnabled) autocompleteToggle.classList.add('active');

  autocompleteToggle.addEventListener('click', () => {
    state.autocompleteEnabled = !state.autocompleteEnabled;
    autocompleteToggle.classList.toggle('active', state.autocompleteEnabled);
    localStorage.setItem('forge-autocomplete', JSON.stringify(state.autocompleteEnabled));
    if (!state.autocompleteEnabled) {
      clearAutocomplete();
    }
    refreshAcStatus();
  });

  // ── Autocomplete Provider Selection ────────────────────────
  function updateAcProviderUI() {
    document.querySelectorAll('.ac-provider-item').forEach(item => {
      item.classList.toggle('active', item.dataset.acProvider === state.autocompleteProvider);
    });
  }

  // Initialize active state from stored preference
  updateAcProviderUI();

  document.querySelectorAll('.ac-provider-item').forEach(item => {
    item.addEventListener('click', () => {
      state.autocompleteProvider = item.dataset.acProvider;
      localStorage.setItem('forge-ac-provider', state.autocompleteProvider);
      updateAcProviderUI();
      clearAutocomplete();
      refreshAcStatus();
    });
  });

  // ── Ollama Health Check ────────────────────────────────────
  async function checkOllama() {
    try {
      const health = await forgeAPI.ollamaHealth();
      state.ollamaAvailable = health.available;
      const statusEl = $('#ollamaAcStatus');
      if (health.available) {
        statusEl.textContent = `${health.models.length} Modell(e)`;
        statusEl.style.color = 'var(--green)';
      } else {
        statusEl.textContent = 'Offline';
        statusEl.style.color = 'var(--text-muted)';
      }
    } catch {
      state.ollamaAvailable = false;
    }
    refreshAcStatus();
  }

  // ── Hugging Face Health Check ──────────────────────────────
  function updateHfStatus(health) {
    state.hfAvailable = health.available;
    const statusEl = $('#hfAcStatus');
    if (health.available) {
      statusEl.textContent = 'Online';
      statusEl.style.color = 'var(--green)';
    } else if (health.noKey) {
      statusEl.textContent = 'Kein Key';
      statusEl.style.color = 'var(--text-muted)';
    } else if (health.unauthorized) {
      statusEl.textContent = 'Key ungültig';
      statusEl.style.color = 'var(--red)';
    } else if (health.rateLimited) {
      statusEl.textContent = 'Rate-Limit';
      statusEl.style.color = 'var(--orange)';
    } else if (health.loading) {
      const secs = health.estimatedTime ? `~${Math.ceil(health.estimatedTime)}s` : '';
      statusEl.textContent = `Lädt ${secs}`;
      statusEl.style.color = 'var(--gold)';
    } else {
      statusEl.textContent = 'Offline';
      statusEl.style.color = 'var(--text-muted)';
    }
  }

  async function checkHuggingFace() {
    try {
      const health = await forgeAPI.hfHealth();
      updateHfStatus(health);
    } catch {
      state.hfAvailable = false;
    }
    refreshAcStatus();
  }

  // ── HF API Key Input ──────────────────────────────────────
  const hfKeyInput = $('#hfKeyInput');
  const hfKeyBtn = $('#hfKeyBtn');

  // Restore saved key
  const savedHfKey = localStorage.getItem('forge-hf-key') || '';
  if (savedHfKey) {
    hfKeyInput.value = savedHfKey;
    // Send key to main process on startup
    forgeAPI.hfSetApiKey(savedHfKey).then(health => { updateHfStatus(health); refreshAcStatus(); });
  }

  async function submitHfKey() {
    const key = hfKeyInput.value.trim();
    localStorage.setItem('forge-hf-key', key);
    const statusEl = $('#hfAcStatus');
    statusEl.textContent = 'Prüfe...';
    statusEl.style.color = 'var(--text-muted)';
    const health = await forgeAPI.hfSetApiKey(key);
    updateHfStatus(health);
  }

  hfKeyBtn.addEventListener('click', submitHfKey);
  hfKeyInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') submitHfKey();
  });

  // Run both checks on startup
  checkOllama();
  if (!savedHfKey) checkHuggingFace();
  // Re-check Ollama every 30s, HF every 60s
  setInterval(checkOllama, 30000);
  setInterval(checkHuggingFace, 60000);

  // ── Keyboard Shortcuts ───────────────────────────────────────
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 't') {
      e.preventDefault();
      createTab(false);
    }
    if (e.ctrlKey && e.key === 'w') {
      e.preventDefault();
      if (state.activeTabId) closeTab(state.activeTabId);
    }
    if (e.ctrlKey && e.key === 'l') {
      e.preventDefault();
      const tab = state.tabs.find(t => t.id === state.activeTabId);
      if (tab) tab.term.clear();
    }
    if (e.ctrlKey && (e.key === '+' || e.key === '=')) {
      e.preventDefault();
      changeFontSize(1);
    }
    if (e.ctrlKey && e.key === '-') {
      e.preventDefault();
      changeFontSize(-1);
    }
    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
      e.preventDefault();
      openScreenshotPicker();
    }
    if (e.key === 'Escape' && screenshotOverlay.classList.contains('visible')) {
      e.preventDefault();
      closeScreenshotPicker();
    }
  });
</script>

</body>
</html>
